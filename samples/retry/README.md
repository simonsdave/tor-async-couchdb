# Retry Sample
This service implements a simple RESTful service that
builds on the [basic sample](../basic).
Specifically, this sample illustrates how
to implement on-write retry logic that works with CouchDB's
Multi-Version Concurrency Control (MVCC) approach to conflicts.
If you compare the [basic sample's service logic](../basic/service.py)
with this sample's service logic [service.py](service.py) what you'll
notice is that the difference are focused on how conflicts are handled.

Just like the [basic sample](../basic),
this sample is a 2-tier application - an app tier talking to a data tier.
The app tier is a service that exposes a RESTful API
which allows the creation, retrieval, update and delete of fruit resources.
The application tier is implemented using using
Tornado's [Asynchronous and non-Blocking I/O](http://tornado.readthedocs.org/en/latest/guide/async.html)
and ```tor-async-couchdb```.
The data tier is implemented using CouchDB.

# Creating the CouchDB Database

To create the CouchDB database go through exactly the same process
you did for the [basic sample](../basic).

# Running the Service

Just like installing the CouchDB database, running the service
follows the same process as the [basic sample](../basic).

# Is the Service Working?

## Integration Tests
Same story here as the [basic sample](../basic).

## Stress Tests

Finally we get to something that's different to the [basic sample](../basic):-)
We'll use the same logic from the [basic sample](../basic) re stress tests to
derive confidence that the service is working correctly. Where the story starts
to differ from the [basic sample](../basic) is that this sample should now
successfully handle lots of concurrent
```POST```, ```GET```, ```PUT``` and ```DELETE``` requests.
To convince yourself of this, edit the [loadgen](../loadgen) utility so it's
driving all of these types of requests and then run it against the
[basic sample](../basic) and you should see lots of errors. One specific
example you should observe in the service's error log is messages that look
like the following:

```
2015-04-27T10:47:23.375+00:00 INFO async_model_actions CouchDB took 13 ms
 to respond with 409 to 'PUT' against
 >>>http://127.0.0.1:5984/tor_async_couchdb_sample/345d17dae686f2b43588108519e8a7a4<<<
```

The ```409``` HTTP response code indicates a concurrency problem on a ```PUT```
to CouchDB and what you'll notice is that the [basic sample](../basic)
does not recover from these failures so there will be errors when running [loadgen](../loadgen).
Now try running that same load through this sample (with the retry
logic in place) and you should still obsere ```409``` errors in the
service log but no errors will be generated by the service's API because
the service has been modified to handle and resolve the ```409``` errors using
retry logic.  

# Exercising the Service's API
This is starting to sound like a broken record but what you should
observe is that the service's API responds just like the API did
in the [basic sample](../basic).
